import{o as T,f as S,b as H,u as L,d as F,q as B,r as m,F as W,a as k,E as p,T as q,U as G,e as Z,g as b,j as s,k as r,z as M,h as C,y as V,m as g,V as K,n as X,Y as Q,Z as j,aG as tt,aH as et,ao as at,A as st,B as nt,C as ot,au as it,p as rt,l as lt}from"./vendor.79e55f37.js";import{_ as R,a as ut,b as dt,p as ht}from"./index.4a9946a1.js";const ct={props:{width:{type:Number,default:800},height:{type:Number,default:300},lineWidth:{type:Number,default:4},lineColor:{type:String,default:"#000000"},bgColor:{type:String,default:""},isCrop:{type:Boolean,default:!1},isClearBgColor:{type:Boolean,default:!0}},data(){return{hasDrew:!1,resultImg:"",points:[],canvasTxt:null,startX:0,startY:0,isDrawing:!1,sratio:1}},computed:{ratio(){return this.height/this.width},stageInfo(){return this.$refs.canvas.getBoundingClientRect()},myBg(){return this.bgColor?this.bgColor:"rgba(255, 255, 255, 0)"}},watch:{myBg:function(t){this.$refs.canvas.style.background=t}},beforeMount(){window.addEventListener("resize",this.$_resizeHandler)},beforeDestroy(){window.removeEventListener("resize",this.$_resizeHandler)},mounted(){const t=this.$refs.canvas;t.height=this.height,t.width=this.width,t.style.background=this.myBg,this.$_resizeHandler(),document.onmouseup=()=>{this.isDrawing=!1}},methods:{$_resizeHandler(){const t=this.$refs.canvas;t.style.width=this.width+"px";const e=parseFloat(window.getComputedStyle(t).width);t.style.height=this.ratio*e+"px",this.canvasTxt=t.getContext("2d"),this.canvasTxt.scale(1*this.sratio,1*this.sratio),this.sratio=e/this.width,this.canvasTxt.scale(1/this.sratio,1/this.sratio)},mouseDown(t){t=t||event,t.preventDefault(),this.isDrawing=!0,this.hasDrew=!0;let e={x:t.offsetX,y:t.offsetY};this.drawStart(e)},mouseMove(t){if(t=t||event,t.preventDefault(),this.isDrawing){let e={x:t.offsetX,y:t.offsetY};this.drawMove(e)}},mouseUp(t){t=t||event,t.preventDefault();let e={x:t.offsetX,y:t.offsetY};this.drawEnd(e),this.isDrawing=!1},touchStart(t){if(t=t||event,t.preventDefault(),this.hasDrew=!0,t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawStart(e)}},touchMove(t){if(t=t||event,t.preventDefault(),t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawMove(e)}},touchEnd(t){if(t=t||event,t.preventDefault(),t.touches.length===1){let e={x:t.targetTouches[0].clientX-this.$refs.canvas.getBoundingClientRect().left,y:t.targetTouches[0].clientY-this.$refs.canvas.getBoundingClientRect().top};this.drawEnd(e)}},drawStart(t){this.startX=t.x,this.startY=t.y,this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.lineWidth=this.lineWidth*this.sratio,this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.points.push(t)},drawMove(t){this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.strokeStyle=this.lineColor,this.canvasTxt.lineWidth=this.lineWidth*this.sratio,this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.startY=t.y,this.startX=t.x,this.points.push(t)},drawEnd(t){this.canvasTxt.beginPath(),this.canvasTxt.moveTo(this.startX,this.startY),this.canvasTxt.lineTo(t.x,t.y),this.canvasTxt.lineCap="round",this.canvasTxt.lineJoin="round",this.canvasTxt.stroke(),this.canvasTxt.closePath(),this.points.push(t),this.points.push({x:-1,y:-1})},generate(){return new Promise((e,f)=>{if(!this.hasDrew){f("Warning: Not Signned!");return}var l=this.canvasTxt.getImageData(0,0,this.$refs.canvas.width,this.$refs.canvas.height);this.canvasTxt.globalCompositeOperation="destination-over",this.canvasTxt.fillStyle=this.myBg,this.canvasTxt.fillRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.resultImg=this.$refs.canvas.toDataURL();var h=this.resultImg;if(this.canvasTxt.clearRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.canvasTxt.putImageData(l,0,0),this.canvasTxt.globalCompositeOperation="source-over",this.isCrop){const n=this.getCropArea(l.data);var a=document.createElement("canvas");const u=a.getContext("2d");a.width=n[2]-n[0],a.height=n[3]-n[1];const d=this.canvasTxt.getImageData(...n);u.globalCompositeOperation="destination-over",u.putImageData(d,0,0),u.fillStyle=this.myBg,u.fillRect(0,0,a.width,a.height),h=a.toDataURL(),a=null}e(h)})},reset(){this.canvasTxt.clearRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height),this.isClearBgColor&&(this.$emit("update:bgColor",""),this.$refs.canvas.style.background="rgba(255, 255, 255, 0)"),this.points=[],this.hasDrew=!1,this.resultImg=""},getCropArea(t){for(var e=this.$refs.canvas.width,f=0,l=this.$refs.canvas.height,h=0,a=0;a<this.$refs.canvas.width;a++)for(var n=0;n<this.$refs.canvas.height;n++){var u=(a+this.$refs.canvas.width*n)*4;(t[u]>0||t[u+1]>0||t[u+2]||t[u+3]>0)&&(h=Math.max(n,h),f=Math.max(a,f),l=Math.min(n,l),e=Math.min(a,e))}return e++,f++,l++,h++,[e,l,f,h]}}};function ft(t,e,f,l,h,a){return T(),S("canvas",{ref:"canvas",onMousedown:e[0]||(e[0]=(...n)=>a.mouseDown&&a.mouseDown(...n)),onMousemove:e[1]||(e[1]=(...n)=>a.mouseMove&&a.mouseMove(...n)),onMouseup:e[2]||(e[2]=(...n)=>a.mouseUp&&a.mouseUp(...n)),onTouchstart:e[3]||(e[3]=(...n)=>a.touchStart&&a.touchStart(...n)),onTouchmove:e[4]||(e[4]=(...n)=>a.touchMove&&a.touchMove(...n)),onTouchend:e[5]||(e[5]=(...n)=>a.touchEnd&&a.touchEnd(...n))},null,544)}var Y=R(ct,[["render",ft],["__scopeId","data-v-acbd7c1e"]]);Y.install=function(t){this.installed||(this.installed=!0,t.component("vueEsign",Y))};const vt={class:"box"},mt={class:"card"},pt={key:0,style:{width:"60%",display:"flex","justify-content":"right"}},gt=g("\u6682\u5B58"),_t=g("\u4FEE\u6539"),xt=g("\u63D0\u4EA4"),yt={props:{enableEdit:{type:Boolean,default:!0},formData:String,formId:String,formDataId:String,change:{type:Boolean,default:!1}},setup(t){const e=t,f=H(),l=L(),h=F();let a=B({}),n=B({}),u=B({});const d=m(null),_=m();let D=f.query._id||e.formId;const y=h.state.userInfo;W(async()=>{if(_.value=(await k.get(`/form/${D}`)).data,_.value.setting.user_range===1&&!localStorage.getItem("user")){p.error("\u8BF7\u5148\u767B\u5F55"),await l.replace({name:"login"});return}else _.value.setting.user_range===2&&q.prompt("","\u8BF7\u8F93\u5165\u79D8\u94A5",{confirmButtonText:"\u786E\u5B9A",showClose:!1,inputType:"password",showCancelButton:!1,inputValidator:o=>o===_.value.setting.password,inputErrorMessage:"\u79D8\u94A5\u9519\u8BEF"}).then(({value:o})=>{p.success({message:"\u79D8\u94A5\u6B63\u786E"})});a=_.value.struct,d.value.setFormJson(a),await G(()=>{localStorage.getItem("formData")?d.value.setFormData(JSON.parse(localStorage.getItem("formData"))):e.formData&&d.value.setFormData(JSON.parse(e.formData)),!e.change&&!e.enableEdit&&d.value.disableForm()})});const E=()=>{d.value.getFormData().then(o=>{let i=JSON.stringify(o);localStorage.setItem("formData",i)})},$=()=>{d.value.getFormData().then(o=>{let i=JSON.stringify(o),c=y?y._id:void 0,w=K().format("YYYY-MM-DD HH:mm:ss");k.post(`/data/${D}`,{create_time:w,user_id:c,data:i}).then(I=>{I.status!==200?p.error("\u63D0\u4EA4\u5931\u8D25\uFF01"):(p.success("\u63D0\u4EA4\u6210\u529F\uFF01"),l.push(`/user/${c}`))}),localStorage.removeItem("formData")}).catch(o=>{p.error(o)})},v=()=>{d.value.getFormData().then(o=>{let i=JSON.stringify(o);y._id,console.log(e),k.put(`/data/${e.formDataId}`,{data:i}).then(c=>{c.status!==200?p.error("\u63D0\u4EA4\u5931\u8D25\uFF01"):p.success("\u63D0\u4EA4\u6210\u529F\uFF01")})})};return(o,i)=>{const c=X,w=Z("v-form-render");return T(),S("div",vt,[b("div",mt,[e.enableEdit?(T(),S("span",pt,[s(c,{onClick:E},{default:r(()=>[gt]),_:1})])):M("",!0),s(w,{"form-json":C(a),"form-data":C(n),"option-data":C(u),ref_key:"vFormRef",ref:d},null,8,["form-json","form-data","option-data"]),e.change?(T(),V(c,{key:1,type:"primary",style:{width:"200px"},onClick:v},{default:r(()=>[_t]),_:1})):M("",!0),e.enableEdit?(T(),V(c,{key:2,type:"primary",style:{width:"200px"},onClick:$},{default:r(()=>[xt]),_:1})):M("",!0)])])}}};var wt=R(yt,[["__scopeId","data-v-12786c6b"]]);const J=t=>(rt("data-v-0a23d702"),t=t(),lt(),t),Tt={class:"app-container"},bt=g("\u5BA1\u6838"),Ct=g("\u5BA1\u6279\u610F\u89C1"),Dt={style:{display:"flex",width:"100%","justify-content":"center"}},$t=J(()=>b("br",null,null,-1)),It={style:{"text-align":"center"}},St=g("\u6E05\u7A7A"),Et=g("\u901A\u8FC7"),Bt=g("\u4E0D\u901A\u8FC7"),kt=J(()=>b("br",null,null,-1)),Mt={setup(t){const e=m([]),f=m([]),l=m(!1),h=m(),a=m(),n=m(),u=m(""),d=m(),_=F(),D=v=>{d.value=v,h.value=v.data,a.value=v.form._id,l.value=!0};function y(){ut().then(v=>e.value=v.data),dt().then(v=>f.value=v.data)}const E=()=>{u.value="",n.value.reset()},$=v=>{n.value.generate().then(o=>{console.log(o),ht(d.value._id,{user_id:_.state.userInfo._id,index:d.value.audit_user_index,opinion:u.value,sign:o,result:v}).then(i=>{l.value=!1,p.success("\u5BA1\u6838\u6210\u529F"),y()})})};return y(),(v,o)=>{const i=Q,c=X,w=j,I=tt,P=et,O=at,U=st,N=nt,z=ot,A=it;return T(),S("div",Tt,[s(P,{"tab-position":"left"},{default:r(()=>[s(I,{label:"\u7B49\u5F85\u5BA1\u6279"},{default:r(()=>[s(w,{data:e.value},{default:r(()=>[s(i,{type:"index",align:"center"}),s(i,{label:"\u4E1A\u52A1\u540D\u79F0",align:"center",prop:"form.name"}),s(i,{label:"\u586B\u5199\u4EBA",align:"center",prop:"user.name"}),s(i,{label:"\u586B\u5199\u8005\u90E8\u95E8",align:"center",prop:"user.deptName"}),s(i,{label:"\u586B\u5199\u65F6\u95F4",align:"center",prop:"create_time",width:"180"}),s(i,{label:"\u64CD\u4F5C",align:"center","class-name":"small-padding fixed-width"},{default:r(x=>[s(c,{text:"",icon:"View",onClick:Rt=>D(x.row)},{default:r(()=>[bt]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),s(I,{label:"\u5BA1\u6279\u5386\u53F2"},{default:r(()=>[s(w,{data:f.value},{default:r(()=>[s(i,{type:"index",align:"center"}),s(i,{label:"\u4E1A\u52A1\u540D\u79F0",align:"center",prop:"form.name"}),s(i,{label:"\u586B\u5199\u4EBA",align:"center",prop:"user.name"}),s(i,{label:"\u586B\u5199\u8005\u90E8\u95E8",align:"center",prop:"user.deptName"}),s(i,{label:"\u586B\u5199\u65F6\u95F4",align:"center",prop:"create_time",width:"180"})]),_:1},8,["data"])]),_:1})]),_:1}),s(A,{top:"5vh",title:"\u5BA1\u6838",modelValue:l.value,"onUpdate:modelValue":o[3]||(o[3]=x=>l.value=x),width:"80vw"},{default:r(()=>[s(C(wt),{"form-id":a.value,"enable-edit":!1,"form-data":h.value},null,8,["form-id","form-data"]),s(O,null,{default:r(()=>[Ct]),_:1}),b("span",Dt,[s(z,{style:{width:"30vw",border:"1px dashed gray",padding:"20px"}},{default:r(()=>[s(N,{label:"\u610F\u89C1"},{default:r(()=>[s(U,{modelValue:u.value,"onUpdate:modelValue":o[0]||(o[0]=x=>u.value=x)},null,8,["modelValue"])]),_:1}),s(N,{required:"",label:"\u7B7E\u540D"},{default:r(()=>[s(C(Y),{ref_key:"sign",ref:n,isClearBgColor:!1,bgColor:"#eceef1",width:300,height:150,isCrop:!1,lineWidth:6,lineColor:"#000000"},null,512)]),_:1})]),_:1})]),$t,b("div",It,[s(c,{type:"info",onClick:E},{default:r(()=>[St]),_:1}),s(c,{type:"success",onClick:o[1]||(o[1]=x=>$(!0))},{default:r(()=>[Et]),_:1}),s(c,{type:"danger",onClick:o[2]||(o[2]=x=>$(!1))},{default:r(()=>[Bt]),_:1})]),kt]),_:1},8,["modelValue"])])}}};var Ft=R(Mt,[["__scopeId","data-v-0a23d702"]]);export{Ft as default};
